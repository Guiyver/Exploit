print("Ran1")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local Character = player.Character or player.CharacterAdded:Wait()
player.CharacterAdded:Connect(function(v) Character = v end)

local leaderstats = player:WaitForChild("leaderstats")
local stage = leaderstats:FindFirstChild("Stage") or leaderstats:FindFirstChild("Stages")

local function extractNumber(v)
    local str = tostring(v)
    local match = str:match("%d+%.?%d*")
    if match then
        return tonumber(match)
    else
        return nil
    end
end

local currentstage = nil

local function DoObby()
print("Ran2")
    if not currentstage then
        if Start == "Current Stage" or Looped then
            if stage then
                currentstage = stage.Value
            else
                if Start == "Current Stage" then
                    warn("ERROR: Cannot determine Current Stage. Please enter the stage number manually. Alternatively, if there's a nearby teleport, please walk through there before trying again.")
                end
                if Looped then
                    return true
                end
            end
        else
            currentstage = Start
        end
    end
    local checkpointfolder = nil
    local loop = 0
    local function SearchForFolder(v)
        local IsNumberCheck = extractNumber(v)
        if IsNumberCheck and #v.Parent:GetChildren() > 2 then
            local FoundStages = 1
            for _,v2 in pairs(v.Parent:GetChildren()) do
                loop += 1
                if loop == 7000 then
                    loop = 0
                    task.wait()
                end
                local IsNumberCheck2 = extractNumber(v2)
                if IsNumberCheck2 then
                    FoundStages += 1
                end
            end
            if FoundStages > #v.Parent:GetChildren()/2 then
                checkpointfolder = v.Parent
                break
            end
        end
    end
    for _,v in pairs(workspace:GetDescendants()) do
        loop += 1
        if loop == 7000 then
            loop = 0
            task.wait()
        end
        if checkpointfolder then
            break
        end
        if v:IsA("SpawnLocation") then
            SearchForFolder(v)
        end
    end
    if not checkpointfolder then
        for _,v in pairs(workspace:GetDescendants()) do
            loop += 1
            if loop == 7000 then
                loop = 0
                task.wait()
            end
            if checkpointfolder then
                break
            end
            if v:IsA("BasePart") then
                SearchForFolder(v)
            end
        end
    end
    if not checkpointfolder then
        for _,v in pairs(workspace:GetDescendants()) do
            loop += 1
            if loop == 7000 then
                loop = 0
                task.wait()
            end
            if checkpointfolder then
                break
            end
            if v:IsA("Model") then
                SearchForFolder(v)
            end
        end
    end
    if checkpointfolder then
        while currentstage < Finish do
            local stagefound = false
            for _,v in pairs(checkpointfolder:GetChildren()) do
                local number = extractNumber(v)
                if number == currentstage + 1 then
                    stagefound = true
                    Character:PivotTo(v:GetPivot() * CFrame.new(0, 2, 0))
                    if stage then
                        repeat
                            task.wait()
                        until stage.Value == currentstage
                    else
                        task.wait(WaitBetweenTeleport)
                    end
                    currentstage += 1
                end
            end
            if stagefound == false then
                break
            end
        end
    else
        warn("ERROR: Checkpoints not found!")
    end
end

if Looped then
    while Looped do
        local error = DoObby()
        if error then
            break
        end
        task.wait()
    end
else
    DoObby()
end
