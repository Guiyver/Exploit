local players = game:GetService("Players")
local localPlayer = players.LocalPlayer
local Holder = Instance.new("Folder", game.CoreGui)
Holder.Name = "ESP"

local friendColor = Color3.fromRGB(0, 0, 255)
local enemyColor = Color3.fromRGB(255, 0, 0)
local useTeamColor = true

local function createBox(name)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = name
    box.Size = Vector3.new(1, 2, 1)
    box.Color3 = Color3.fromRGB(100, 100, 100)
    box.Transparency = 0.7
    box.ZIndex = 0
    box.AlwaysOnTop = false
    box.Visible = false
    return box
end

local function createNameTag(name)
    local nameTag = Instance.new("BillboardGui")
    nameTag.Name = name
    nameTag.Size = UDim2.new(0, 200, 0, 50)
    nameTag.AlwaysOnTop = true
    nameTag.StudsOffset = Vector3.new(0, 1.8, 0)

    local tag = Instance.new("TextLabel", nameTag)
    tag.Name = "Tag"
    tag.BackgroundTransparency = 1
    tag.Position = UDim2.new(0, -50, 0, 0)
    tag.Size = UDim2.new(0, 300, 0, 20)
    tag.TextSize = 15
    tag.TextColor3 = Color3.fromRGB(100, 100, 100)
    tag.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    tag.TextStrokeTransparency = 0.4
    tag.Text = "nil"
    tag.Font = Enum.Font.SourceSansBold
    tag.TextScaled = false

    return nameTag
end

local function updateESP(player)
    local character = player.Character
    if not character then return end
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end

    local playerHolder = Holder:FindFirstChild(player.Name) or Instance.new("Folder", Holder)
    playerHolder.Name = player.Name
    playerHolder:ClearAllChildren()

    local box = createBox(player.Name .. "Box")
    box.Adornee = character
    box.Parent = playerHolder

    local nameTag = createNameTag(player.Name .. "NameTag")
    nameTag.Adornee = character:FindFirstChild("Head")
    nameTag.Parent = playerHolder

    local tag = nameTag:FindFirstChild("Tag")
    if tag then
        tag.Text = player.DisplayName .. "(" .. player.Name .. ")"
        local updateTag = function()
            if character and character:FindFirstChild("HumanoidRootPart") and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
                tag.Text = player.DisplayName .. "(" .. player.Name .. ")" .. "(" .. (character.HumanoidRootPart.Position - localPlayer.Character.HumanoidRootPart.Position).magnitude .. ")"
            end
        end
        game:GetService("RunService").RenderStepped:Connect(updateTag)
    end

    local color = useTeamColor and player.TeamColor.Color or (localPlayer.TeamColor == player.TeamColor and friendColor or enemyColor)
    box.Color3 = color
    tag.TextColor3 = color
end

local function onPlayerAdded(player)
    player.CharacterAdded:Connect(function() updateESP(player) end)
    player.CharacterRemoving:Connect(function() if Holder:FindFirstChild(player.Name) then Holder[player.Name]:Destroy() end end)
    if player.Character then updateESP(player) end
end

local function onPlayerRemoving(player)
    if Holder:FindFirstChild(player.Name) then Holder[player.Name]:Destroy() end
end

players.PlayerAdded:Connect(onPlayerAdded)
players.PlayerRemoving:Connect
