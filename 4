--v6

local players = game:GetService("Players")
local runService = game:GetService("RunService")
local workspace = game:GetService("Workspace")
local plr = players.LocalPlayer

-- Settings
_G.FriendColor = Color3.fromRGB(0, 0, 255)
_G.EnemyColor = Color3.fromRGB(255, 0, 0)
_G.ItemColor = Color3.fromRGB(0, 255, 0)  -- New color setting for items
_G.UseTeamColor = true
_G.ItemKeywords = {"Spawn", "Keyword2", "Keyword3"}  -- Table of keywords

-- Create ESP Holder
local Holder = Instance.new("Folder", game.CoreGui)
Holder.Name = "ESP"

-- Function to create a Box Handle Adornment
local function createBox(name)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = name
    box.Size = Vector3.new(1, 2, 1)
    box.Color3 = Color3.fromRGB(100, 100, 100)
    box.Transparency = 0.7
    box.ZIndex = 0
    box.AlwaysOnTop = false
    box.Visible = false
    return box
end

-- Function to create a NameTag GUI
local function createNameTag(name)
    local nameTag = Instance.new("BillboardGui")
    nameTag.Name = name
    nameTag.Enabled = false
    nameTag.Size = UDim2.new(0, 200, 0, 50)
    nameTag.AlwaysOnTop = true
    nameTag.StudsOffset = Vector3.new(0, 1.8, 0)

    local tag = Instance.new("TextLabel", nameTag)
    tag.Name = "Tag"
    tag.BackgroundTransparency = 1
    tag.Position = UDim2.new(0, -50, 0, 0)
    tag.Size = UDim2.new(0, 300, 0, 20)
    tag.TextSize = 15
    tag.TextColor3 = Color3.fromRGB(100, 100, 100)
    tag.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    tag.TextStrokeTransparency = 0.4
    tag.Text = "nil"
    tag.Font = Enum.Font.SourceSansBold
    tag.TextScaled = false
    return nameTag
end

-- Function to check if the character and parts are valid
local function isValidCharacter(character)
    return character and character:IsA("Model") and character:FindFirstChild("HumanoidRootPart")
end

-- Function to load a character's ESP
local function loadCharacter(player)
    if not isValidCharacter(player.Character) then return end

    local holder = Holder:FindFirstChild(player.Name) or Instance.new("Folder", Holder)
    holder.Name = player.Name
    holder:ClearAllChildren()

    local box = createBox(player.Name .. "Box")
    box.Adornee = player.Character
    box.Parent = holder

    local nameTag = createNameTag(player.Name .. "NameTag")
    nameTag.Enabled = true
    nameTag.Parent = holder
    local head = player.Character:FindFirstChild("Head")
    if not head then return end
    nameTag.Adornee = head

    local tag = nameTag:FindFirstChild("Tag")
    local function updateTag()
        if not isValidCharacter(player.Character) or not isValidCharacter(plr.Character) then return end
        local distance = math.floor((player.Character.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude)
        local displayName = player.DisplayName == player.Name and player.Name or player.DisplayName .. " (" .. player.Name .. ")"
        tag.Text = displayName .. " (" .. distance .. ")"
        if _G.UseTeamColor then
            box.Color3 = player.TeamColor.Color
            tag.TextColor3 = player.TeamColor.Color
        else
            local color = plr.TeamColor == player.TeamColor and _G.FriendColor or _G.EnemyColor
            box.Color3 = color
            tag.TextColor3 = color
        end
    end

    updateTag()
    local updateConnection
    updateConnection = runService.RenderStepped:Connect(function()
        if not isValidCharacter(player.Character) then
            if updateConnection then updateConnection:Disconnect() end
            return
        end
        updateTag()
    end)

    player.CharacterAdded:Connect(function(char)
        char:WaitForChild("Humanoid")
        box.Adornee = char
        local head = char:WaitForChild("Head", 5)
        if not head then
            if updateConnection then updateConnection:Disconnect() end
            return
        end
        nameTag.Adornee = head
        if updateConnection then updateConnection:Disconnect() end
        updateConnection = runService.RenderStepped:Connect(updateTag)
    end)
end

-- Function to unload a character's ESP
local function unloadCharacter(player)
    local holder = Holder:FindFirstChild(player.Name)
    if holder then
        holder:Destroy()
    end
end

-- Function to create ESP for an item
local function createItemESP(item)
	print("Creating ESP for " .. item.Name)
    if not item:IsA("BasePart") and not item:IsA("Model") then return end

    local holder = Holder:FindFirstChild(item.Name) or Instance.new("Folder", Holder)
    holder.Name = item.Name
    holder:ClearAllChildren()

    local nameTag = createNameTag(item.Name .. "NameTag")
    nameTag.Enabled = true
    nameTag.Parent = holder

    if item:IsA("BasePart") then
        local box = createBox(item.Name .. "Box")
        box.Adornee = item
        box.Color3 = _G.ItemColor
        box.Parent = holder
        nameTag.Adornee = item
    elseif item:IsA("Model") then
        for _, part in ipairs(item:GetDescendants()) do
            if part:IsA("BasePart") then
                local box = createBox(part.Name .. "Box")
                box.Adornee = part
                box.Color3 = _G.ItemColor
                box.Parent = holder
            end
        end
        local primaryPart = item.PrimaryPart or item:FindFirstChildOfClass("BasePart")
        if primaryPart then
            nameTag.Adornee = primaryPart
        else
            nameTag.Enabled = false
        end
    end

    local tag = nameTag:FindFirstChild("Tag")
    local function updateTag()
        if not item or not item:IsA("BasePart") and not item:IsA("Model") or not isValidCharacter(plr.Character) then return end
        local distance = math.floor((item.Position - plr.Character.HumanoidRootPart.Position).Magnitude)
        tag.Text = item.Name .. " (" .. distance .. ")"
    end

    updateTag()
    local updateConnection
    updateConnection = runService.RenderStepped:Connect(function()
        if not item or not item:IsA("BasePart") and not item:IsA("Model") then
            if updateConnection then updateConnection:Disconnect() end
            return
        end
        updateTag()
    end)
end

-- Function to search and create ESPs for items
local function searchAndCreateItemESP()
    for _, item in ipairs(workspace:GetDescendants()) do
        for _, keyword in ipairs(_G.ItemKeywords) do
            if string.find(item.Name, keyword) then
                print("Creating ESP for " .. item.Name)
                createItemESP(item)
                break
            end
        end
    end
end

-- Setup ESP for all players
for _, player in ipairs(players:GetPlayers()) do
    if player ~= plr then
        loadCharacter(player)
    end
end

-- ESP setup for new players
players.PlayerAdded:Connect(loadCharacter)

-- ESP removal for players leaving
players.PlayerRemoving:Connect(unloadCharacter)

-- Hide the LocalPlayer's name
plr.NameDisplayDistance = 0

-- Run the item ESP search
searchAndCreateItemESP()
