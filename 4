--v4

local players = game:GetService("Players")
local runService = game:GetService("RunService")
local plr = players.LocalPlayer

-- Settings
_G.FriendColor = Color3.fromRGB(0, 0, 255)
_G.EnemyColor = Color3.fromRGB(255, 0, 0)
_G.UseTeamColor = true

-- Create ESP Holder
local Holder = Instance.new("Folder", game.CoreGui)
Holder.Name = "ESP"

-- Function to create a Box Handle Adornment
local function createBox(name)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = name
    box.Size = Vector3.new(1, 2, 1)
    box.Color3 = Color3.fromRGB(100, 100, 100)
    box.Transparency = 0.7
    box.ZIndex = 0
    box.AlwaysOnTop = false
    box.Visible = false
    return box
end

-- Function to create a NameTag GUI
local function createNameTag(name)
    local nameTag = Instance.new("BillboardGui")
    nameTag.Name = name
    nameTag.Enabled = false
    nameTag.Size = UDim2.new(0, 200, 0, 50)
    nameTag.AlwaysOnTop = true
    nameTag.StudsOffset = Vector3.new(0, 1.8, 0)

    local tag = Instance.new("TextLabel", nameTag)
    tag.Name = "Tag"
    tag.BackgroundTransparency = 1
    tag.Position = UDim2.new(0, -50, 0, 0)
    tag.Size = UDim2.new(0, 300, 0, 20)
    tag.TextSize = 15
    tag.TextColor3 = Color3.fromRGB(100, 100, 100)
    tag.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    tag.TextStrokeTransparency = 0.4
    tag.Text = "nil"
    tag.Font = Enum.Font.SourceSansBold
    tag.TextScaled = false
    return nameTag
end

-- Function to check if the character and parts are valid
local function isValidCharacter(character)
    return character and character:IsA("Model") and character:FindFirstChild("HumanoidRootPart")
end

-- Function to load a character's ESP
local function loadCharacter(player)
    if not isValidCharacter(player.Character) then return end

    local holder = Holder:FindFirstChild(player.Name) or Instance.new("Folder", Holder)
    holder.Name = player.Name
    holder:ClearAllChildren()

    local box = createBox(player.Name .. "Box")
    box.Adornee = player.Character
    box.Parent = holder

    local nameTag = createNameTag(player.Name .. "NameTag")
    nameTag.Enabled = true
    nameTag.Parent = holder
    local head = player.Character:FindFirstChild("Head")
    if not head then return end
    nameTag.Adornee = head

    local tag = nameTag:FindFirstChild("Tag")
    local function updateTag()
        if not isValidCharacter(player.Character) or not isValidCharacter(plr.Character) then return end
        local distance = math.floor((player.Character.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude)
        local displayName = player.DisplayName == player.Name and player.Name or player.DisplayName .. " (" .. player.Name .. ")"
        tag.Text = displayName .. " (" .. distance .. ")"
        if _G.UseTeamColor then
            box.Color3 = player.TeamColor.Color
            tag.TextColor3 = player.TeamColor.Color
        else
            local color = plr.TeamColor == player.TeamColor and _G.FriendColor or _G.EnemyColor
            box.Color3 = color
            tag.TextColor3 = color
        end
    end

    updateTag()
    local updateConnection
    updateConnection = runService.RenderStepped:Connect(function()
        if not isValidCharacter(player.Character) then
            if updateConnection then updateConnection:Disconnect() end
            return
        end
        updateTag()
    end)

    player.CharacterAdded:Connect(function(char)
        char:WaitForChild("Humanoid")
        box.Adornee = char
        local head = char:WaitForChild("Head", 5)
        if not head then
            if updateConnection then updateConnection:Disconnect() end
            return
        end
        nameTag.Adornee = head
        if updateConnection then updateConnection:Disconnect() end
        updateConnection = runService.RenderStepped:Connect(updateTag)
    end)
end

-- Function to unload a character's ESP
local function unloadCharacter(player)
    local holder = Holder:FindFirstChild(player.Name)
    if holder then
        holder:Destroy()
    end
end

-- Setup ESP for all players
for _, player in ipairs(players:GetPlayers()) do
    if player ~= plr then
        loadCharacter(player)
    end
end

-- ESP setup for new players
players.PlayerAdded:Connect(loadCharacter)

-- ESP removal for players leaving
players.PlayerRemoving:Connect(unloadCharacter)

-- Hide the LocalPlayer's name
plr.NameDisplayDistance = 0
